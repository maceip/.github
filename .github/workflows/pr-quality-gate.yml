name: PR Quality Gate

on:
  workflow_call:
    inputs:
      java-version:
        type: string
        default: '21'
      ndk-version:
        type: string
        default: ''
      gradle-task:
        type: string
        default: 'assembleDebug'
      lint-task:
        type: string
        default: 'lint'
      test-task:
        type: string
        default: 'testDebugUnitTest'
      app-module:
        type: string
        default: 'app'
      submodules:
        type: boolean
        default: false
      lfs:
        type: boolean
        default: false
      extra-setup-script:
        type: string
        default: ''
      working-directory:
        type: string
        default: '.'
      screenshot-task:
        description: 'Gradle screenshot verify task (empty to skip)'
        type: string
        default: ''
      has-instrumentation-tests:
        description: 'Run instrumentation tests on self-hosted emulator'
        type: boolean
        default: false
      package-name:
        description: 'Android package name for smoke test'
        type: string
        default: ''
      main-activity:
        description: 'Main activity for smoke test'
        type: string
        default: '.MainActivity'
      expected-native-libs:
        type: string
        default: ''
      min-apk-size:
        type: number
        default: 0
      check-alignment:
        type: boolean
        default: false
      detekt-config-repo:
        type: string
        default: ''

permissions:
  contents: read

jobs:
  lint:
    name: Lint
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: ${{ inputs.submodules && 'recursive' || 'false' }}
          lfs: ${{ inputs.lfs }}

      - uses: actions/setup-java@v4
        with:
          java-version: ${{ inputs.java-version }}
          distribution: temurin
          cache: gradle

      - uses: android-actions/setup-android@v3

      - name: Install NDK
        if: inputs.ndk-version != ''
        run: sdkmanager --install "ndk;${{ inputs.ndk-version }}"

      - name: Download shared detekt config
        if: inputs.detekt-config-repo != ''
        run: |
          mkdir -p config
          curl -fsSL "https://raw.githubusercontent.com/${{ inputs.detekt-config-repo }}/main/configs/detekt.yml" \
            -o config/detekt.yml

      - name: Extra setup
        if: inputs.extra-setup-script != ''
        run: ${{ inputs.extra-setup-script }}

      - name: Run Android Lint
        working-directory: ${{ inputs.working-directory }}
        run: ./gradlew ${{ inputs.lint-task }} --no-daemon

      - name: Upload lint results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: lint-results
          path: |
            **/build/reports/lint-results*.html
            **/build/reports/lint-results*.xml

  unit-test:
    name: Unit Tests
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: ${{ inputs.submodules && 'recursive' || 'false' }}
          lfs: ${{ inputs.lfs }}

      - uses: actions/setup-java@v4
        with:
          java-version: ${{ inputs.java-version }}
          distribution: temurin
          cache: gradle

      - uses: android-actions/setup-android@v3

      - name: Install NDK
        if: inputs.ndk-version != ''
        run: sdkmanager --install "ndk;${{ inputs.ndk-version }}"

      - name: Extra setup
        if: inputs.extra-setup-script != ''
        run: ${{ inputs.extra-setup-script }}

      - name: Run unit tests
        working-directory: ${{ inputs.working-directory }}
        run: ./gradlew ${{ inputs.test-task }} --no-daemon

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: unit-test-results
          path: |
            **/build/reports/tests/
            **/build/test-results/

  screenshot-test:
    name: Screenshot Tests
    if: inputs.screenshot-task != ''
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: ${{ inputs.submodules && 'recursive' || 'false' }}
          lfs: ${{ inputs.lfs }}

      - uses: actions/setup-java@v4
        with:
          java-version: ${{ inputs.java-version }}
          distribution: temurin
          cache: gradle

      - uses: android-actions/setup-android@v3

      - name: Extra setup
        if: inputs.extra-setup-script != ''
        run: ${{ inputs.extra-setup-script }}

      - name: Run screenshot verification
        working-directory: ${{ inputs.working-directory }}
        run: ./gradlew ${{ inputs.screenshot-task }} --no-daemon

      - name: Upload screenshot diffs
        if: failure()
        uses: actions/upload-artifact@v4
        with:
          name: screenshot-diffs
          path: '**/build/paparazzi/failures/'

  build:
    name: Build
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: ${{ inputs.submodules && 'recursive' || 'false' }}
          lfs: ${{ inputs.lfs }}

      - uses: actions/setup-java@v4
        with:
          java-version: ${{ inputs.java-version }}
          distribution: temurin
          cache: gradle

      - uses: android-actions/setup-android@v3

      - name: Install NDK
        if: inputs.ndk-version != ''
        run: sdkmanager --install "ndk;${{ inputs.ndk-version }}"

      - name: Extra setup
        if: inputs.extra-setup-script != ''
        run: ${{ inputs.extra-setup-script }}

      - name: Build APK
        working-directory: ${{ inputs.working-directory }}
        run: ./gradlew ${{ inputs.gradle-task }} --no-daemon

      - name: Find and verify APK
        id: find-apk
        run: |
          APK_PATH=$(find "${{ inputs.app-module }}/build/outputs/apk" -name "*.apk" | head -1)
          if [ -z "$APK_PATH" ]; then
            echo "::error::No APK found"
            exit 1
          fi
          echo "apk_path=$APK_PATH" >> "$GITHUB_OUTPUT"

          if ! unzip -l "$APK_PATH" | grep -q 'classes.dex'; then
            echo "::error::APK missing classes.dex"
            exit 1
          fi
          echo "APK size: $(stat -c%s "$APK_PATH") bytes"

      - name: Upload APK artifact
        uses: actions/upload-artifact@v4
        with:
          name: pr-apk
          path: ${{ steps.find-apk.outputs.apk_path }}

  smoke-test:
    name: Smoke Test
    needs: build
    if: inputs.package-name != ''
    runs-on: self-hosted
    concurrency:
      group: emulator
      cancel-in-progress: false
    steps:
      - uses: actions/download-artifact@v4
        with:
          name: pr-apk
          path: smoke-apk

      - name: Find APK
        id: find-apk
        run: echo "path=$(find smoke-apk -name '*.apk' | head -1)" >> "$GITHUB_OUTPUT"

      - name: Smoke test (flock serialized)
        run: |
          exec 9>/tmp/emulator-smoke.lock
          flock -w 300 9 || { echo "::error::Timed out waiting for emulator lock"; exit 1; }

          adb wait-for-device
          TIMEOUT=120; ELAPSED=0
          while [ "$(adb shell getprop sys.boot_completed 2>/dev/null | tr -d '\r')" != "1" ]; do
            [ $ELAPSED -ge $TIMEOUT ] && echo "::error::Emulator boot timeout" && exit 1
            sleep 2; ELAPSED=$((ELAPSED + 2))
          done

          PACKAGE="${{ inputs.package-name }}"
          ACTIVITY="${{ inputs.main-activity }}"
          APK="${{ steps.find-apk.outputs.path }}"

          adb install -r "$APK"
          adb shell am force-stop "$PACKAGE"
          adb shell pm clear "$PACKAGE" 2>/dev/null || true
          adb logcat -c
          adb shell am start -n "${PACKAGE}/${ACTIVITY}"
          sleep 15

          CRASH_LOG=$(adb shell logcat -d -s AndroidRuntime:E)
          ACTIVITY_STATUS=$(adb shell dumpsys activity activities 2>/dev/null | grep "$PACKAGE" || true)

          adb shell am force-stop "$PACKAGE" 2>/dev/null || true
          adb uninstall "$PACKAGE" 2>/dev/null || true

          if echo "$CRASH_LOG" | grep -q "FATAL EXCEPTION"; then
            echo "::error::App crashed on launch!"
            echo "$CRASH_LOG"
            exit 1
          fi
          [ -z "$ACTIVITY_STATUS" ] && echo "::error::Activity not running" && exit 1
          echo "Smoke test PASSED"

  e2e:
    name: E2E Tests
    needs: build
    if: inputs.has-instrumentation-tests
    runs-on: self-hosted
    concurrency:
      group: emulator
      cancel-in-progress: false
    steps:
      - uses: actions/checkout@v4
        with:
          submodules: ${{ inputs.submodules && 'recursive' || 'false' }}
          lfs: ${{ inputs.lfs }}

      - uses: actions/setup-java@v4
        with:
          java-version: ${{ inputs.java-version }}
          distribution: temurin
          cache: gradle

      - uses: android-actions/setup-android@v3

      - name: Install NDK
        if: inputs.ndk-version != ''
        run: sdkmanager --install "ndk;${{ inputs.ndk-version }}"

      - name: Extra setup
        if: inputs.extra-setup-script != ''
        run: ${{ inputs.extra-setup-script }}

      - name: Run instrumentation tests
        run: |
          exec 9>/tmp/emulator-smoke.lock
          flock -w 300 9 || { echo "::error::Timed out waiting for emulator lock"; exit 1; }
          cd ${{ inputs.working-directory }}
          ./gradlew connectedDebugAndroidTest --no-daemon

      - name: Upload test results
        if: always()
        uses: actions/upload-artifact@v4
        with:
          name: e2e-results
          path: '**/build/reports/androidTests/'
