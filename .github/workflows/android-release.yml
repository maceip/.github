name: Android Release

on:
  workflow_call:
    inputs:
      java-version:
        type: string
        default: '21'
      ndk-version:
        type: string
        default: ''
      app-module:
        type: string
        default: 'app'
      app-name:
        description: 'Application name for SBOM and release'
        type: string
        required: true
      submodules:
        type: boolean
        default: false
      lfs:
        type: boolean
        default: false
      extra-setup-script:
        type: string
        default: ''
      working-directory:
        type: string
        default: '.'
      gradle-task:
        type: string
        default: 'assembleDebug'
      test-task:
        type: string
        default: 'testDebugUnitTest'
      screenshot-task:
        type: string
        default: ''
      expected-native-libs:
        type: string
        default: ''
      min-apk-size:
        type: number
        default: 0
      check-alignment:
        type: boolean
        default: false
    secrets:
      KEYSTORE_BASE64:
        required: false
      KEYSTORE_PASSWORD:
        required: false
      KEY_ALIAS:
        required: false
      KEY_PASSWORD:
        required: false

permissions:
  contents: write
  issues: read

jobs:
  security-gate:
    name: Security Gate
    runs-on: ubuntu-latest
    steps:
      - name: Check for open critical CVEs
        id: check
        env:
          GH_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          COUNT=$(gh issue list --repo "${{ github.repository }}" --label security --state open --json number -q 'length')
          if [ "$COUNT" -gt 0 ]; then
            echo "::warning::$COUNT open security issue(s) found"
          fi
          echo "Security gate passed"

  build-and-release:
    name: Build & Release
    needs: security-gate
    runs-on: ubuntu-latest
    steps:
      - name: Checkout
        uses: actions/checkout@v4
        with:
          fetch-depth: 0
          submodules: ${{ inputs.submodules && 'recursive' || 'false' }}
          lfs: ${{ inputs.lfs }}

      - uses: actions/setup-java@v4
        with:
          java-version: ${{ inputs.java-version }}
          distribution: temurin
          cache: gradle

      - uses: android-actions/setup-android@v3

      - name: Install NDK
        if: inputs.ndk-version != ''
        run: sdkmanager --install "ndk;${{ inputs.ndk-version }}"

      - name: Extra setup
        if: inputs.extra-setup-script != ''
        run: ${{ inputs.extra-setup-script }}

      - name: Decode signing keystore
        run: |
          if [ -n "$KEYSTORE_B64" ]; then
            echo "$KEYSTORE_B64" | base64 -d > keystore.jks
            echo "KEYSTORE_FILE=$(pwd)/keystore.jks" >> "$GITHUB_ENV"
            echo "KEYSTORE_PASSWORD=$KS_PASS" >> "$GITHUB_ENV"
            echo "KEY_ALIAS=$K_ALIAS" >> "$GITHUB_ENV"
            echo "KEY_PASSWORD=$K_PASS" >> "$GITHUB_ENV"
          else
            echo "No signing keystore configured, skipping"
          fi
        env:
          KEYSTORE_B64: ${{ secrets.KEYSTORE_BASE64 }}
          KS_PASS: ${{ secrets.KEYSTORE_PASSWORD }}
          K_ALIAS: ${{ secrets.KEY_ALIAS }}
          K_PASS: ${{ secrets.KEY_PASSWORD }}

      - name: Build APK
        working-directory: ${{ inputs.working-directory }}
        run: ./gradlew ${{ inputs.gradle-task }} --no-daemon

      - name: Run unit tests
        working-directory: ${{ inputs.working-directory }}
        run: ./gradlew ${{ inputs.test-task }} --no-daemon
        continue-on-error: true

      - name: Run screenshot verification
        if: inputs.screenshot-task != ''
        working-directory: ${{ inputs.working-directory }}
        run: ./gradlew ${{ inputs.screenshot-task }} --no-daemon

      - name: Find APK
        id: find-apk
        shell: bash
        run: |
          APK_PATH=$(find "${{ inputs.app-module }}/build/outputs/apk" -name "*.apk" | head -1)
          if [ -z "$APK_PATH" ]; then
            echo "::error::No APK found"
            exit 1
          fi
          echo "apk_path=$APK_PATH" >> "$GITHUB_OUTPUT"

      - name: Verify APK
        run: |
          APK="${{ steps.find-apk.outputs.apk_path }}"
          if ! unzip -l "$APK" | grep -q 'classes.dex'; then
            echo "::error::APK missing classes.dex"
            exit 1
          fi
          APK_SIZE=$(stat -c%s "$APK")
          echo "APK size: $((APK_SIZE / 1024 / 1024)) MB ($APK_SIZE bytes)"
          echo "APK verification passed"

      - name: Get next version
        id: version
        run: |
          LATEST_TAG=$(git describe --tags --abbrev=0 2>/dev/null || echo "v0.0.0")
          VERSION=${LATEST_TAG#v}
          IFS='.' read -r MAJOR MINOR PATCH <<< "$VERSION"
          PATCH=$((PATCH + 1))
          if [ "$PATCH" -ge 100 ]; then PATCH=0; MINOR=$((MINOR + 1)); fi
          if [ "$MINOR" -ge 100 ]; then MINOR=0; MAJOR=$((MAJOR + 1)); fi
          echo "new_version=v${MAJOR}.${MINOR}.${PATCH}" >> "$GITHUB_OUTPUT"

      - name: Generate dependency report
        working-directory: ${{ inputs.working-directory }}
        run: |
          ./gradlew ${{ inputs.app-module }}:dependencies --configuration releaseRuntimeClasspath > dependencies-full.txt 2>&1 || true
          ./gradlew ${{ inputs.app-module }}:dependencies --configuration debugRuntimeClasspath >> dependencies-full.txt 2>&1 || true

      - uses: actions/setup-python@v5
        with:
          python-version: '3.11'

      - name: Install Python dependencies
        run: pip install requests matplotlib numpy

      - name: Generate SBOM and staleness analysis
        working-directory: ${{ inputs.working-directory }}
        env:
          APP_NAME: ${{ inputs.app-name }}
          APP_VERSION: ${{ steps.version.outputs.new_version }}
        run: |
          python3 -c "
          import json, re, requests, os
          from datetime import datetime
          from collections import defaultdict
          import matplotlib
          matplotlib.use('Agg')
          import matplotlib.pyplot as plt
          import matplotlib.patches as mpatches
          import numpy as np

          plt.style.use('dark_background')
          COLORS = {
              'bg': '#0d1117', 'card': '#161b22', 'border': '#30363d',
              'text': '#c9d1d9', 'green': '#3fb950', 'yellow': '#d29922',
              'orange': '#db6d28', 'red': '#f85149', 'gray': '#484f58',
              'purple': '#a371f7', 'blue': '#58a6ff'
          }

          def parse_gradle_dependencies(file_path):
              deps = {}
              with open(file_path, 'r') as f:
                  content = f.read()
              pattern = r'[+\\\\]--- ([a-zA-Z0-9._-]+):([a-zA-Z0-9._-]+):([0-9a-zA-Z._-]+)'
              for group, artifact, version in re.findall(pattern, content):
                  key = f'{group}:{artifact}'
                  if key not in deps:
                      deps[key] = {'group': group, 'artifact': artifact, 'version': version}
              return deps

          def get_maven_metadata(group, artifact):
              group_path = group.replace('.', '/')
              for url in [
                  f'https://repo1.maven.org/maven2/{group_path}/{artifact}/maven-metadata.xml',
                  f'https://dl.google.com/dl/android/maven2/{group_path}/{artifact}/maven-metadata.xml'
              ]:
                  try:
                      resp = requests.get(url, timeout=10)
                      if resp.status_code == 200:
                          latest = re.search(r'<release>([^<]+)</release>', resp.text)
                          if not latest:
                              latest = re.search(r'<latest>([^<]+)</latest>', resp.text)
                          return {
                              'latest': latest.group(1) if latest else None,
                              'versions': re.findall(r'<version>([^<]+)</version>', resp.text)
                          }
                  except Exception:
                      pass
              return None

          def main():
              app_name = os.environ.get('APP_NAME', 'android-app')
              app_version = os.environ.get('APP_VERSION', '0.0.0')
              print('Parsing dependencies...')
              deps = parse_gradle_dependencies('dependencies-full.txt')
              print(f'Found {len(deps)} dependencies')

              sbom = {
                  'bomFormat': 'CycloneDX', 'specVersion': '1.4', 'version': 1,
                  'metadata': {
                      'timestamp': datetime.utcnow().isoformat() + 'Z',
                      'component': {'type': 'application', 'name': app_name, 'version': app_version}
                  },
                  'components': []
              }
              staleness_data = []

              for i, (key, dep) in enumerate(deps.items()):
                  print(f'  [{i+1}/{len(deps)}] {key}')
                  metadata = get_maven_metadata(dep['group'], dep['artifact'])
                  component = {
                      'type': 'library', 'group': dep['group'], 'name': dep['artifact'],
                      'version': dep['version'],
                      'purl': f\"pkg:maven/{dep['group']}/{dep['artifact']}@{dep['version']}\"
                  }
                  staleness = {
                      'dependency': key, 'current_version': dep['version'],
                      'latest_version': None, 'versions_behind': None, 'status': 'unknown'
                  }
                  if metadata and metadata.get('latest'):
                      staleness['latest_version'] = metadata['latest']
                      component['latestVersion'] = metadata['latest']
                      if dep['version'] == metadata['latest']:
                          staleness['status'] = 'up-to-date'
                      else:
                          versions = metadata.get('versions', [])
                          try:
                              behind = len(versions) - versions.index(dep['version']) - 1
                              staleness['versions_behind'] = behind
                              if behind == 0: staleness['status'] = 'up-to-date'
                              elif behind <= 2: staleness['status'] = 'slightly-outdated'
                              elif behind <= 5: staleness['status'] = 'outdated'
                              else: staleness['status'] = 'very-outdated'
                          except ValueError:
                              staleness['status'] = 'outdated'
                  sbom['components'].append(component)
                  staleness_data.append(staleness)

              with open('sbom.json', 'w') as f:
                  json.dump(sbom, f, indent=2)

              summary = {
                  'total': len(staleness_data),
                  'up_to_date': sum(1 for s in staleness_data if s['status'] == 'up-to-date'),
                  'slightly_outdated': sum(1 for s in staleness_data if s['status'] == 'slightly-outdated'),
                  'outdated': sum(1 for s in staleness_data if s['status'] == 'outdated'),
                  'very_outdated': sum(1 for s in staleness_data if s['status'] == 'very-outdated'),
                  'unknown': sum(1 for s in staleness_data if s['status'] == 'unknown')
              }
              report = {
                  'generated_at': datetime.utcnow().isoformat() + 'Z',
                  'summary': summary,
                  'dependencies': sorted(staleness_data, key=lambda x: -(x['versions_behind'] or 0))
              }
              with open('staleness-report.json', 'w') as f:
                  json.dump(report, f, indent=2)

              health_score = int((summary['up_to_date'] / max(summary['total'], 1)) * 100)
              with open(os.environ.get('GITHUB_OUTPUT', '/dev/null'), 'a') as f:
                  f.write(f'health_score={health_score}\n')

              with open('sbom-summary.md', 'w') as f:
                  f.write(f'# SBOM Report\n\nHealth: {health_score}%% | Total: {summary[\"total\"]}\n\n')
                  f.write('| Status | Count |\n|--------|-------|\n')
                  for label, key in [('Up to Date','up_to_date'),('Slight Lag','slightly_outdated'),('Outdated','outdated'),('Critical','very_outdated'),('Unknown','unknown')]:
                      f.write(f'| {label} | {summary[key]} |\n')
              print('Done!')

          if __name__ == '__main__':
              main()
          "

      - name: Rename APK for release
        id: release-apk
        run: |
          APK_NAME="${{ inputs.app-name }}-${{ steps.version.outputs.new_version }}-debug.apk"
          cp "${{ steps.find-apk.outputs.apk_path }}" "$APK_NAME"
          echo "apk_path=$APK_NAME" >> "$GITHUB_OUTPUT"

      - name: Create Release
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ steps.version.outputs.new_version }}
          name: Release ${{ steps.version.outputs.new_version }}
          body: |
            ### ${{ steps.version.outputs.new_version }}
            Commit: `${{ github.sha }}`
          files: |
            ${{ steps.release-apk.outputs.apk_path }}
            sbom.json
            staleness-report.json
            sbom-summary.md
          generate_release_notes: false
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}

      - name: Summary
        run: |
          echo "## Release Complete" >> "$GITHUB_STEP_SUMMARY"
          echo "**Version:** ${{ steps.version.outputs.new_version }}" >> "$GITHUB_STEP_SUMMARY"
          echo "**Artifacts:** APK, SBOM, Staleness Report" >> "$GITHUB_STEP_SUMMARY"
